  {% extends 'ecgdatabank/base.html' %}
  {% load subscription_tags %}

  {% load static %}
  
  {% block title %}ECG Morphology Analysis{% endblock %}
  
  {% block extra_css %}
  <link rel="stylesheet" href="{% static 'CSS/Morphology.css' %}">
  {% endblock %}
  
  {% block content %}
  <div class="content">
<header class="header">
  <div class="header-content">
    <div class="header-left">
      <h2>ECG Morphology Analysis</h2>
    </div>

    <div class="header-right">
      <div class="view-toggle">
        <button class="toggle-btn {% if not request.user|has_feature:'Morphology_Draw' %}disabled-feature{% endif %} "
        {% if not request.user|has_feature:'Morphology_Draw' %}onclick="showUpgradeToast(){% endif %}"
         onclick="showMorphologySection()">Morphology Draw</button>
        <button class="toggle-btn{% if not request.user|has_feature:'Morphology_Analysis' %}disabled-feature{% endif %} "
        {% if not request.user|has_feature:'Morphology_Analysis' %}onclick="showUpgradeToast(){% endif %}" onclick="showUploadSection()">Upload ECG Image</button>
      </div>
    </div>
  </div>
</header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Morphology Draw Section -->
    <div id="morphologySection">
      <div class="card">
        <div class="card-header">
          <div class="header-icon">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
              <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
              <path d="M2 2l7.586 7.586"></path>
              <circle cx="11" cy="11" r="2"></circle>
            </svg>
          </div>
          <h2 class="card-title">Morphology Draw</h2>
        </div>

        <div id="drawingArea" class="canvas-container">
          <canvas id="drawingCanvas" style="width:100%; height:400px; border:1px solid #ccc; background-color:#fff;"></canvas>
        </div>

        <div class="controls-grid">
        <div class="control-group">
            <label for="replicationCount" class="control-label">Replication Count</label>
            <input type="number" id="replicationCount" placeholder="Enter replication (<10)" min="1" max="9"
            class="control-input">
        </div>

        <div class="button-group">
            <button id="augmentBtn" onclick="augmentSignal()" class="btn btn-secondary">Augment</button>
            <button id="viewBtn" onclick="showGraph()" class="btn btn-secondary">View Signal</button>
            <button id="resetBtn" onclick="resetDrawing()" class="btn btn-tertiary">Reset Drawing</button>
        </div>
        </div>

        <div class="action-section">
        <input type="text" id="patientIdInput" placeholder="Enter Patient ID" class="control-input">
        
        <select id="arrhythmiaSelect" onchange="updateSubarrhythmia()" class="control-input">
            <option value="">Select Arrhythmia</option>
        </select>
        <select id="subarrhythmiaSelect" class="control-input" style="display: none;">
            <option value="">Select Subarrhythmia</option>
        </select>
        <button id="saveBtn" onclick="saveData()" class="btn btn-primary">Save Drawing</button>
        </div>

        <!-- Signal plot initially hidden -->
        <div id="signalPlot" class="signal-card" style="display: none;"></div>
      </div>
    </div>
    
    <!-- Upload ECG Image Section -->
    <div id="uploadSection" class="section" >
      <div class="card">
        <div class="card-header">
          <div class="header-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="25px" height="25px" viewBox="0 0 24 24" fill="none">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M9.29289 1.29289C9.48043 1.10536 9.73478 1 10 1H18C19.6569 1 21 2.34315 21 4V8C21 8.55228 20.5523 9 20 9C19.4477 9 19 8.55228 19 8V4C19 3.44772 18.5523 3 18 3H11V8C11 8.55228 10.5523 9 10 9H5V20C5 20.5523 5.44772 21 6 21H10C10.5523 21 11 21.4477 11 22C11 22.5523 10.5523 23 10 23H6C4.34315 23 3 21.6569 3 20V8C3 7.73478 3.10536 7.48043 3.29289 7.29289L9.29289 1.29289ZM6.41421 7H9V4.41421L6.41421 7ZM20.1716 18.7574C20.6951 17.967 21 17.0191 21 16C21 13.2386 18.7614 11 16 11C13.2386 11 11 13.2386 11 16C11 18.7614 13.2386 21 16 21C17.0191 21 17.967 20.6951 18.7574 20.1716L21.2929 22.7071C21.6834 23.0976 22.3166 23.0976 22.7071 22.7071C23.0976 22.3166 23.0976 21.6834 22.7071 21.2929L20.1716 18.7574ZM13 16C13 14.3431 14.3431 13 16 13C17.6569 13 19 14.3431 19 16C19 17.6569 17.6569 19 16 19C14.3431 19 13 17.6569 13 16Z" fill="#000000"/>
            </svg>
          </div>
          <h2 class="card-title">ECG Image Analysis</h2>
        </div>

        <div class="upload-area" id="uploadArea">
          <form id="uploadForm" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="upload-icon">
            <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
            </div>
            <label for="fileInput" class="file-label" id="fileLabel" onclick="event.stopPropagation();">
              Click to Upload ECG Image
            </label>
            <input type="file" id="fileInput" class="file-input" accept="image/jpeg,image/png"
              onchange="handleFileSelection(this)">
          </form>
        </div>

        <div id="plot" class="card hidden">
          <h3 class="signal-title">
            ECG Signal
            <a onclick="originalimage()" class="link-inline"><i class="fa-solid fa-image"></i></a>
          </h3>
          <div id="ecgChart" class="ecgChart"></div>
        </div>

        <form id="ecgForm" method="POST" enctype="multipart/form-data" class="hidden">
          {% csrf_token %}
          <div class="classification-card">
            <h3 class="classification-title">Classify Arrhythmia</h3>
            <div class="classification-grid">
              <div class="control-group">
                <label for="leads" class="control-label">Lead:</label>
                <select id="leads" name="lead" class="control-input" required>
                  <option value="">Select Lead</option>
                </select>
              </div>
              <div class="control-group">
                <label for="arrhythmia" class="control-label">Arrhythmia:</label>
                <select id="arrhythmia" name="arrhythmia" class="control-input" required>
                  <option value="">Select Main Arrhythmia</option>
                  <option value="Myocardial Infarction">Myocardial Infarction</option>
                  <option value="Atrial Fibrillation & Atrial Flutter">Atrial Fibrillation & Atrial Flutter</option>
                  <option value="Blocks">HeartBlock</option>
                  <option value="Junctional Rhythm">Junctional Rhythm</option>
                  <option value="Premature Atrial Contraction">Premature Atrial Contraction</option>
                  <option value="Premature Ventricular Contraction">Premature Ventricular Contraction</option>
                  <option value="Ventricular Fibrillation and Asystole">Ventricular Fibrillation and Asystole</option>
                  <option value="Noise">Noise</option>
                  <option value="Others">Others</option>
                  <option value="LBBB">LBBB & RBBB</option>
                  <option value="Artifacts">Artifacts</option>
                  <option value="SINUS-ARR">SINUS-ARR</option>
                  <option value="ShortPause">ShortPause</option>
                  <option value="TC">TC</option>
                  <option value="WIDE-QRS">WIDE-QRS</option>
                  <option value="Abnormal">Abnormal</option>
                  <option value="Normal">Normal</option>
                </select>
              </div>
              <div class="control-group">
                <label for="subArrhythmia" class="control-label">Sub-Arrhythmia:</label>
                <select id="subArrhythmia" name="sub_arrhythmia" class="control-input" required>
                  <option value="">Select Sub-Arrhythmia</option>
                </select>
              </div>
            </div>

            <div class="action-buttons">
                 <button type="button" class="btn btn-primary flex-grow" onclick="handleECGSubmit()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>Submit</button>

                <button type="button" class="btn btn-tertiary" onclick="hide()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="1 4 1 10 7 10"></polyline>
                    <polyline points="23 20 23 14 17 14"></polyline>
                    <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                </svg>
                Reset</button>

              <button type="button" class="btn btn-secondary" onclick="uploadECG()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>Re-upload</button>         
            </div>
          </div>
        </form>
      </div>    
    </div>

    
  </main>
  </div>
  {% endblock %}
  
  {% block scripts %}
  
  <script src="{% static 'js/morph_index.js' %}"></script>
  <script>var uploadFileUrl = "{% url 'uploaded_file' %}"</script>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  {% endblock %}