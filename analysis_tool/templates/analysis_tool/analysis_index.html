{% extends 'ecgdatabank/base.html' %}
{% load static %} 
{% block title %} Analysis Tool{% endblock %}

{% block extra_css %}
<style>
/* Use theme variables for consistency */
    :root {
    --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    --card-hover-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    --primary-color: #3498db; /* Default primary color for buttons and accents */
    --primary-hover: #f0f8ff; /* Hover background for file input */
    --progress-bar-bg: #1e90ff; /* Progress bar color */

        /* Alert system colors */
    --alert-success: #22c55e;
    --alert-success-bg: #ecfdf5;
    --alert-success-text: #065f46;
    --alert-error: #ef4444;
    --alert-error-bg: #fef2f2;
    --alert-error-text: #991b1b;
    --alert-warning: #f59e0b;
    --alert-warning-bg: #fffbeb;
    --alert-warning-text: #92400e;
    --alert-info: #3b82f6;
    --alert-info-bg: #eff6ff;
    --alert-info-text: #1e40af;
    --alert-primary: #3b82f6;
    --alert-primary-bg: #f5f3ff;
    --alert-primary-text: #2563eb;
    --alert-secondary: #6b7280;
    --alert-secondary-bg: #f9fafb;
    --alert-secondary-text: #374151;
    }

    [data-theme="dark"] {
    --primary-color: #60a5fa; /* Lighter shade for dark mode */
    --primary-hover: #2a3b5a; /* Darker hover background for dark mode */
    --progress-bar-bg: #60a5fa; /* Adjusted for dark mode */
    --chartTitle-color:#000000;

         /* Alert system colors for dark mode */
    --alert-success: #34d399;
    --alert-success-bg: #1a2e2a;
    --alert-success-text: #a7f3d0;
    --alert-error: #f87171;
    --alert-error-bg: #3d1f1f;
    --alert-error-text: #fecaca;
    --alert-warning: #fbbf24;
    --alert-warning-bg: #3d2e1a;
    --alert-warning-text: #fcdf9c;
    --alert-info: #60a5fa;
    --alert-info-bg: #1e2a44;
    --alert-info-text: #bfdbfe;
    --alert-primary: #60a5fa;
    --alert-primary-bg: #2b2a44;
    --alert-primary-text: #bfdbfe;
    --alert-secondary: #9ca3af;
    --alert-secondary-bg: #2d3748;
    --alert-secondary-text: #d1d5db;
    }
    /* Alert System Styles */
      .alert-system-container {
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 10000;
          max-width: 420px;
          width: 100%;
          pointer-events: none;
      }
      
      .alert-item {
          background: var(--background);
          border-radius: var(--border-radius);
          box-shadow: var(--shadow);
          margin-bottom: 12px;
          overflow: hidden;
          pointer-events: auto;
          position: relative;
          transform: translateX(100%);
          opacity: 0;
          transition: var(--transition);
      }
      
      .alert-item.show {
          transform: translateX(0);
          opacity: 1;
      }
      
      .alert-item.hide {
          transform: translateX(100%);
          opacity: 0;
          margin-bottom: 0;
          max-height: 0;
      }
      
      .alert-item::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 4px;
          background: var(--alert-color);
      }
      
      .alert-item.type-success {
          --alert-color: var(--alert-success);
          --alert-bg: var(--alert-success-bg);
          --alert-text: var(--alert-success-text);
      }
      
      .alert-item.type-error {
          --alert-color: var(--alert-error);
          --alert-bg: var(--alert-error-bg);
          --alert-text: var(--alert-error-text);
      }
      
      .alert-item.type-warning {
          --alert-color: var(--alert-warning);
          --alert-bg: var(--alert-warning-bg);
          --alert-text: var(--alert-warning-text);
      }
      
      .alert-item.type-info {
          --alert-color: var(--alert-info);
          --alert-bg: var(--alert-info-bg);
          --alert-text: var(--alert-info-text);
      }
      
      .alert-item.type-primary {
          --alert-color: var(--alert-primary);
          --alert-bg: var(--alert-primary-bg);
          --alert-text: var(--alert-primary-text);
      }
      
      .alert-item.type-secondary {
          --alert-color: var(--alert-secondary);
          --alert-bg: var(--alert-secondary-bg);
          --alert-text: var(--alert-secondary-text);
      }
      
      .alert-content {
          padding: 16px 20px;
          display: flex;
          align-items: flex-start;
          background: var(--alert-bg);
          color: var(--alert-text);
      }
      
      .alert-icon {
          flex-shrink: 0;
          width: 24px;
          height: 24px;
          margin-right: 12px;
          margin-top: 2px;
          color: var(--alert-color);
      }
      
      .alert-icon svg {
          width: 100%;
          height: 100%;
          fill: currentColor;
      }
      
      .alert-body {
          flex: 1;
          min-width: 0;
      }
      
      .alert-title {
          font-weight: 600;
          font-size: 14px;
          margin-bottom: 4px;
          color: var(--alert-text);
      }
      
      .alert-message {
          font-size: 13px;
          line-height: 1.4;
          color: var(--alert-text);
          opacity: 0.8;
      }
      
      .alert-actions {
          margin-top: 12px;
          display: flex;
          gap: 8px;
      }
      
      .alert-action {
          padding: 6px 12px;
          border: none;
          border-radius: var(--border-radius);
          font-size: 12px;
          font-weight: 500;
          cursor: pointer;
          transition: var(--transition);
          background: var(--alert-color);
          color: white;
      }
      
      .alert-action:hover {
          opacity: 0.8;
          transform: translateY(-1px);
      }
      
      .alert-action.secondary {
          background: transparent;
          color: var(--alert-color);
          border: 1px solid var(--alert-color);
      }
      
      .alert-close {
          flex-shrink: 0;
          width: 20px;
          height: 20px;
          background: none;
          border: none;
          cursor: pointer;
          opacity: 0.5;
          transition: opacity 0.2s ease;
          margin-left: 8px;
          color: var(--alert-text);
      }
      
      .alert-close:hover {
          opacity: 1;
      }
      
      .alert-close svg {
          width: 100%;
          height: 100%;
          fill: currentColor;
      }
      
      .alert-progress {
          position: absolute;
          bottom: 0;
          left: 0;
          height: 3px;
          background: var(--alert-color);
          transition: width 0.1s linear;
          opacity: 0.7;
      }
      
      .content {
       padding: 2rem;
      }
    /* File Input Container */
    .file-input-container {
        border: 2px dashed var(--primary-color);
        border-radius: 10px;
        width: 100%;
        text-align: center;
        cursor: pointer;
        font-family: serif; /* Match base font */
        color: var(--primary-color);
        height: 40px;
        padding: 5px 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        transition: background-color 0.3s ease;
    }

    .file-input-container:hover {
        background-color: var(--primary-hover);
    }

    .file-input {
        display: none;
    }

    .file-label {
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        color: var(--primary-color);
        flex-grow: 1;
        text-align: center;
    }

    .refresh-button {
        background: none;
        border: none;
        padding: 0;
        margin-left: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.3s ease, opacity 0.2s ease;
    }

    .refresh-button:hover .refresh-icon {
        transform: rotate(360deg);
    }

    .refresh-button:focus {
        outline: 2px solid var(--primary-color);
        outline-offset: 2px;
    }

    .refresh-button:active .refresh-icon {
        transform: scale(0.9);
    }

    .refresh-icon {
        width: 20px;
        height: 20px;
        color: var(--primary-color);
        transition: transform 0.3s ease;
    }

    /* Analysis Cards */
    .analysis-card {
        height: 250px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        border-radius: 12px; /* Match base stat-box */
        transition: all 0.3s ease-in-out;
        box-shadow: var(--card-shadow);
        cursor: pointer;
    }

    .analysis-card:hover {
        transform: scale(1.05);
        box-shadow: var(--card-hover-shadow);
    }

    /* Card Colors (using theme-compatible colors) */
    .oea-card {
        background-color: rgb(16, 185, 129); /* Greenish shade */
        color: var(--sidebar-text);
    }

    .tmt-card {
        background-color: rgb(59, 130, 246); /* Blue shade */
        color: var(--sidebar-text);
    }

    .holter-card {
        background-color: rgb(248, 113, 113); /* Neutral shade */
        color: var(--sidebar-text);
    }

    .csv-card {
        background-color: rgb(245, 158, 11); /* Red shade */
        color: var(--sidebar-text);
    }

    /* Cards Container */
    #cardsContainer .card {
        height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        border-radius: 12px; /* Match base */
        background-color: var(--stat-box-bg); /* Use stat-box background */
        color: var(--sidebar-text);
        transition: background-color 0.3s ease;
    }

    #cardsContainer .card-body {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    #cardsContainer .card-text {
        font-size: 0.8rem;
        padding: 0 10px;
    }

    /* Images */
    .resized-image {
        width: 100%;
        height: auto;
        object-fit: contain;
    }

    #uploadPopup img {
        max-width: 450px;
        height: 349px;
        border-radius: 10px;
        position: fixed;
        margin-top: 230px;
        left: 20%;
        transform: translateY(-45%);
        box-shadow: none;
        background: none;
    }

    #popcard {
        max-width: 800px;
        max-height: 345px;
        border-radius: 10px;
        position: fixed;
        margin-top: 175px;
        margin-right: 10px;
        left: 52%;
        transform: translateY(-45%);
        box-shadow: none;
        background: none;
        overflow: auto;
    }

    /* Buttons */
    #showOutputButton, #openPopupButton, #viewBtn {
        background-color: var(--primary-color);
        border-color: var(--text-color);
        color: var(--sidebar-text);
        transition: background-color 0.3s ease;
    }

    #showOutputButton:hover, #openPopupButton:hover, #viewBtn:hover {
        background-color: var(--nav-link-hover);
    }

    #showOutputButton {
        display: none;
    }

    /* Header */
    #mainHeader {
        font-size: 40px;
        color: var(--header-text);
        text-align: left;
        margin-bottom: 20px;
        letter-spacing: 1px;
    }

    .col-md-3 h5 {
        margin-top: 25%;
    }

    /* Loading Animation */
    .main {
        display: none;
        margin-top: 175px;
        margin-left: 700px;
    }

    .loading-text {
        font-weight: bold;
        margin-bottom: 10px;
        color: var(--text-color);
    }

    .progress-container {
        width: 300px;
        height: 20px;
        border: 2px solid var(--text-color);
        background-color: var(--background-color);
    }

    .progress-bar {
        height: 100%;
        background-color: var(--progress-bar-bg);
        width: 0%;
        animation: loading 3s infinite;
    }

    @keyframes loading {
        0% { width: 0%; }
        25% { width: 25%; }
        50% { width: 50%; }
        75% { width: 75%; }
        100% { width: 100%; }
    }

    /* Again Button */
    #Again {
        position: fixed;
        bottom: 5px;
        right: 10px;
        background-color: rgba(1, 2, 0, 0.53);
        font-family: serif; /* Match base font */
        color: var(--sidebar-text);
        border-radius: 5px;
        cursor: pointer;
        border-color: var(--text-color);
        transition: background-color 0.3s ease;
    }

    #Again:hover {
        background-color: var(--nav-link-hover);
    }

    /* Information Popups */
    #informations, #informations_csv {
        display: inline-block;
        cursor: pointer;
        font-size: 20px;
        color: var(--primary-color);
        position: relative;
        user-select: none;
    }

    .popup1 {
        position: absolute;
        top: 47%;
        left: 34%;
        background: var(--header-bg);
        border: 1px solid var(--text-color);
        padding: 10px;
        width: auto;
        border-radius: 8px;
        box-shadow: var(--card-shadow);
        z-index: 10;
        color: var(--text-color);
    }

    .popup1.visible {
        display: block;
    }

    /* Chart Container */
    #chart-container {
        display: none;
        margin: 20px auto;
        box-shadow: var(--card-shadow);
        background-color: var(--background-color);
        overflow-y: auto;
        border-radius: 12px; /* Match base */
    }

    #chart-container > div {
        position: relative;
        padding: 15px;
        background-color: var(--header-bg);
        border-radius: 6px;
    }

    #chartTitle.modal-title {
        font-size: 1.5rem;
        color: #000000;
    }

    #close-btn.btn-close {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 1.2rem;
        opacity: 0.7;
        transition: opacity 0.2s ease;
        color: var(--text-color);
    }

    #close-btn.btn-close:hover {
        opacity: 1;
    }

    #plot {
        width: 100%;
        height:475px;
        overflow-y: auto;
    }

</style>
{% endblock %}

{% block content %}
<div class="content">
    <div>
        <h2 id="mainHeader">Analysis Tool</h2><!--class="text-center mb-4"-->
     
        <div class="row">
            <div class="col-md-3">
                <div id="oeaCard" class="card analysis-card oea-card" onclick="navigateToSection('oea')">
                    <div class="card-body">
                        <h5 class="card-title">OOM ECG Analyzer (OEA)</h5>
                        <p class="card-text">Detect arrhythmias using ECG signal processing.</p>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div id="tmtCard" class="card analysis-card tmt-card" onclick="navigateToSection('tmt')">
                    <div class="card-body">
                        <h5 class="card-title">TMT Analysis (Treadmill Test)</h5>
                        <p class="card-text">Analyze treadmill test data for abnormalities.</p>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div id="holterCard" class="card analysis-card holter-card" onclick="navigateToSection('holter')">
                    <div class="card-body">
                        <h5 class="card-title">Holter Data Analysis</h5>
                        <p class="card-text">Monitor long-term ECG trends and variations.</p>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div id="csvCard" class="card analysis-card csv-card" onclick="navigateToSection('csv')">
                    <div class="card-body">
                        <h5 class="card-title">CSV Analysis</h5>
                        <p class="card-text">Process and visualize raw ECG data files.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Section (Initially Hidden) -->
    <div id="uploadSection" class="container mt-4" style="display: none; overflow-y:auto;">
        <h2 class="text-center mb-4" id="uploadTitle"></h2>
        <h4 id="uploadSubtitle"></h4>
        <form id="uploadForm" enctype="multipart/form-data">
            {% csrf_token %} 

            <label class="file-input-container">
                <span class="file-label" id="fileLabel">Click to Upload File</span>
                <input type="file" id="fileInput" class="file-input" onchange="showFileName(this)">
                <button type="button" class="refresh-button" onclick="hide()" title="Reset file selection" aria-label="Reset file selection">
                    <svg class="refresh-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M23 4v6h-6"></path>
                        <path d="M1 20v-6h6"></path>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"></path>
                        <path d="M20.49 15a9 9 0 0 1-14.85 3.36L1 14"></path>
                    </svg>
                </button>
            </label>

            <button type="button" id="openPopupButton" style="background-color:#1bb56cba; border-color:#6c757d;" class="btn btn-primary mt-3" onclick="uploadFile()">Upload</button>
            <button type="button" id="viewBtn" style="background-color:#247dd6; border-color:#6c757d; display:none;" class="btn btn-primary mt-3" onclick="uploadAndPlot()">View</button>
        
        </form>
        <br>

        <div id="chart-container">
            <div style="background-color:white;">
                <h2 id="chartTitle" class="modal-title">ECG Signal</h2>
                <button type="button" id="close-btn" class="btn-close" aria-label="Close" onclick="closeChart()"></button>
                <hr>
                <div id="plot"></div>
            </div>
        </div>

        <div id="uploadPopup" class="popup">
            <img id="uploadPopupImage">
        </div>
        
        <button id="showOutputButton" style="background-color:#0d6efd; border-color:#6c757d;" class="btn btn-primary mt-3" onclick="showOutputPopup()">Show Output</button>
               
        <div id="popcard" class="popup">
            <img id="outputPopupImage" class="resized-image" src="">
        </div> 
    </div>
        
    <!-- Holter Lead Selection (Initially Hidden) -->
    <div id="isLeadForHolter" class="container mt-3" style="display: none;">
        <h4 class="form-label">Lead Type</h4>
        <input type="radio" name="lead" value="12_Lead" checked> 12 Lead 
        <span title="More Info" id="informations" class="info-button">ⓘ</span> 
        <div class="popup1" id="infoPopupHolter" style="display: none;">
            <strong>Information</strong>
            <ul style="margin-top: 5px; padding-left: 18px;">
                <li><strong>12-Lead Data:</strong> Leads I, II, III, aVR, aVL, aVF, V1, V2, V3, V4, V5, V6</li>
            </ul>
        </div>
    </div>

    <!-- CSV Lead Selection (Initially Hidden) -->
    <div id="isLeadForCSV" class="container mt-3" style="display: none;">
        <h4 class="form-label">Lead Type</h4>
        <input type="radio" name="lead" value="2_Lead"> 2 Lead
        <input type="radio" name="lead" value="7_Lead"> 7 Lead
        <input type="radio" name="lead" value="12_Lead" checked> 12 Lead 
        <span title="More Info" id="informations_csv" class="info-button">ⓘ</span> 
        <div class="popup1" id="infoPopupCSV" style="display: none;">
            <strong>Information</strong>
            <ul style="margin-top: 5px; padding-left: 18px;">
                <li><strong>2-Lead Data:</strong> Lead II</li>
                <li><strong>7-Lead Data:</strong> Leads I, II, III, aVR, aVL, aVF, V5</li>
                <li><strong>12-Lead Data:</strong> Leads I, II, III, aVR, aVL, aVF, V1, V2, V3, V4, V5, V6</li>
            </ul>
        </div>
    </div>

    <!-- Arrhythmia Categories (Initially Hidden) -->
    <div class="container" id="cardsContainer" style="display: none;">
        <h3 class="mt-4">Arrhythmia Categories</h3>
        <div class="row">
            <div class="col-md-4">
                <div class="card text-white mb-4 p-3" style="background-color: #10b981;" onclick="fetchFiles('pvc')">
                    <div class="card-body">
                        <h5 class="card-title">Premature Ventricular Contraction</h5>
                        <p class="card-text" style="font-size: 0.8rem;">Isolated, Bigeminy, Trigeminy, Quadrigeminy, Couplet, Triplet, IVR, AIVR, NSVT,VT</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white mb-4 p-3" style="background-color: #3b82f6;" onclick="fetchFiles('pac')">
                    <div class="card-body">
                        <h5 class="card-title">Premature Atrial Contraction</h5>
                        <p class="card-text" style="font-size: 0.8rem;">Isolated, Bigeminy, Trigeminy, Quadrigeminy, Couplet, Triplet, SVT</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white mb-4 p-3" style="background-color: #f87171;" onclick="fetchFiles('afib_afl')">
                    <div class="card-body">
                        <h5 class="card-title">Atrial Fibrillation & Atrial Flutter</h5>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4">
                <div class="card text-white mb-4 p-3" style="background-color: #a855f7;" onclick="fetchFiles('pac_jn', this)">
                    <div class="card-body">
                        <h5 class="card-title">Junctional</h5>
                        <p class="card-text display-6" style="font-size: 0.8rem;">Junctional Rhythm, junctional bradycardia</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white mb-4 p-3" style="background-color: #f59e0b;" onclick="fetchFiles('block', this)">
                    <div class="card-body">
                        <h5 class="card-title">Blocks</h5>
                        <p class="card-text display-6" style="font-size: 0.8rem;">I Degree, Mobitz I, Mobitz II, III Degree</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white mb-4 p-3" style="background-color: #22c55e;" onclick="fetchFiles('vifib_vfl', this)">
                    <div class="card-body">
                        <h5 class="card-title">Ventricular Fibrillation and Asystole</h5>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4">
                <div class="card text-white mb-4 p-3" style="background-color: #f97316;" onclick="fetchFiles('mi', this)">
                    <div class="card-body">
                        <h5 class="card-title">Myocardial Infarction</h5>
                        <p class="card-text display-6" style="font-size: 0.8rem;">T wave abnormality, LBBB, RBBB, Inferior, Lateral</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="fileModal" tabindex="-1" aria-labelledby="fileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="fileModalLabel">File List</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center" id="fileModalBody">
                    <!-- Files will be added here dynamically -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    var uploadFileUrl = "{% url 'upload_file' %}";
    var processImageUrl = "/analysis/process_image/FILENAME_PLACEHOLDER/";
    var fetchFilesUrl = "/analysis/files/CATEGORY_PLACEHOLDER/";
    var processArrhythmiaUrl = "/analysis/process_arrhythmia/CATEGORY_PLACEHOLDER/FILENAME_PLACEHOLDER/?image_name=IMAGE_NAME_PLACEHOLDER&is_lead=LEAD_TYPE_PLACEHOLDER";
</script>
<script src="{% static 'js/analysis_index.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}