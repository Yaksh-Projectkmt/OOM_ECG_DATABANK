{% extends 'ecgdatabank/base.html' %}
{% load static %}
{% load subscription_tags %}
{% block title %}Analysis Tool{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'CSS/ecg_details.css' %}">
{% endblock %}

{% block content %}
<div class="container">
  <input type="hidden" id="csrfToken" value="{{ csrf_token }}">

<div class="header">
  <button class="back-btn" onclick="window.location.href='/ommecgdata/'" aria-label="Go back">
    <i class="fas fa-arrow-left"></i>
  </button>
  <div class="header-text">
    <h2>{{ card_name|default:"Data Management" }}</h2>
    <p>Manage and view your ECG data efficiently with advanced filtering and visualization tools</p>
  </div>
</div>

  <div class="table-container card">
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Sr. No.</th>
            <th>Patient ID</th>
            <th>Lead Type</th>
            <th>Arrhythmia</th>
            <th>Frequency</th>
            <th>duration</th>
            <th>HRV CHart</th>
            <th>Actions</th>
            <th>
              <input type="checkbox" id="selectAll"> SELECT Data
            </th>
          </tr>
        </thead>
        
        <tbody id="ecgTableBody">
          {% for data in page_obj %}
          <tr data-object-id="{{ data.object_id }}" data-lead-value="{{ data.LeadNumeric|default:data.Lead }}" class="fade-in">
            <td><strong>{{ forloop.counter }}</strong></td>
            <td>{{ data.PatientID }}</td>
            <td>{{ data.Lead }}</td>
            <td>{{ data.Arrhythmia }}</td>
            <td>{{ data.Frequency }}</td>
            <td>{{data.duration}}</td>
             <td>  
               <button class="icon-btn scatter-plot" title="Show scatter plot" data-patient="${row.PatientID || ''}" data-id="${row.object_id || ''}" data-arrhythmia="${row.ArrhythmiaType || ''}" data-lead="${row.LeadConfig || '2_lead'}"><i class="fas fa-chart-line hrv-icon"></i></button>
            </td>
             
             <td>  
              <button class="icon-btn delete"
                      data-id="${row.object_id || ''}"
                      data-collection="${row.collection_name || ''}"
                      data-locked="{{ user|has_feature:'delete_data'|yesno:'false,true' }}">
                      <i class="fas fa-trash"></i>
                  </button>             
              </td>
             <td>
              <input type="checkbox"
                      class="row-checkbox"
                      data-id="${row.object_id || ''}"
                      data-collection="${row.collection_name || ''}"
                      data-locked="{{ user|has_feature:'share'|yesno:'false,true' }}">           
             </td>
          </tr>
          <tr class="plot-row" data-plot-id="${row.object_id || ''}" style="display: none;">
          <td colspan="9">
            <div id="plot-container-${row.object_id || ''}" class="plot-container">
              <div class="modal-header">
                  <h5 class="modal-title" style="display:flex; align-items:center; gap:8px;">
                    <i class="fas fa-heartbeat" style="color: var(--danger);"></i>
                              ECG Signal - ${row.PatientID || ''}
                  <!-- Share dropdown -->
                  
                  <div class="share-dropdown">
                    <i class="fas fa-share share-icon" 
                      data-id="${row.object_id || ''}" 
                      data-patient="${row.PatientID || ''}"></i>

                    <div class="share-menu" id="shareMenu-${row.object_id || ''}">
                      <a href="#" class="share-option teams" data-patient="${row.PatientID || ''}">
                        <i class="fab fa-microsoft"></i>
                      </a>
                      <a href="#" class="share-option email" data-patient="${row.PatientID || ''}">
                        <i class="fas fa-envelope"></i>
                      </a>
                    </div>
                  </div>
                  
                </h5>

                <button type="button" class="btn-close plot-close" id="close-${row.object_id || ''}" data-id="${row.object_id || ''}" aria-label="Close"></button>
              </div>
              <div class="plot" id="plot-${row.object_id || ''}"></div>
              <div class="modal-footer d-flex justify-content-between align-items-start flex-wrap">

                <!-- Left: HRV Info -->
                <div class="hrv-info text-start small" id="hrvInfo-${row.object_id || ''}">
                  <div class="hrv-details">
                    <span><strong>Mean RR:</strong> ${hrvInfo.mean_rr} ms</span>
                    <span><strong>SDNN:</strong> ${hrvInfo.sdnn} ms</span>
                    <span><strong>HR:</strong> ${hr_value} bpm</span>
                  </div>
                </div>
                <div class="controls d-flex flex-wrap gap-2 justify-content-end align-items-center">    
                  <div class="arrhythmia-label" id="arrhythmiaContainer-${row.object_id || ''}" style="display: none;">
                    <select class="form-control" id="Arrhythmia-${row.object_id || ''}" name="ArrhythmiaType">
                      <option value=" " selected>Select Arrhythmia Type</option>
                          <option value="Myocardial Infarction">Myocardial Infarction</option>
                          <option value="Atrial Fibrillation & Atrial Flutter">Atrial Fibrillation & Atrial Flutter</option>
                          <option value="HeartBlock">HeartBlock</option>
                          <option value="Junctional Rhythm">Junctional Rhythm</option>
                          <option value="Premature Atrial Contraction">Premature Atrial Contraction</option>
                          <option value="Premature Ventricular Contraction">Premature Ventricular Contraction</option>
                          <option value="Ventricular Fibrillation and Asystole">Ventricular Fibrillation and Asystole</option>
                          <option value="Noise">Noise</option>
                          <option value="Others">Others</option>
                          <option value="LBBB & RBBB">LBBB & RBBB</option>
                          <option value="Artifacts">Artifacts</option>
                          <option value="SINUS-ARR">SINUS-ARR</option>
                          <option value="ShortPause">ShortPause</option>
                          <option value="TC">TC</option>
                          <option value="WIDE-QRS">WIDE-QRS</option>
                          <option value="Abnormal">Abnormal</option>
                          <option value="Normal">Normal</option>
                    </select>
                  </div>
                <div class="download-label" id="downloadContainer-${row.object_id || ''}">
                  <select class="form-control" id="downloadType-${row.object_id || ''}" name="downloadType">
                    <option value="" disabled selected>Download Type</option>
                    <option value="raw_data">Raw Data</option>
                    <option value="plot_png">Plot PNG</option>
                    <option value="pqrst_csv">PQRST CSV</option>
                    <option value="selected_data">Selected Data</option>
                  </select>
                </div>
                <div class="button-group">
                  <button class="btn btn-warning edit-btn" id="editEcgData-${row.object_id || ''}" data-id="${row.object_id || ''}">Edit</button>
                  <button class="btn btn-success save-btn" id="saveData-${row.object_id || ''}" data-id="${row.object_id || ''}">Download</button>
                  <button class="btn btn-primary confirm-edit-btn" id="confirmEditBtn-${row.object_id || ''}" data-id="${row.object_id || ''}" style="display: none;">Confirm</button>
                  <button class="btn btn-secondary close-btn" id="closeBtn-${row.object_id || ''}" style="display: none;">Close</button>     
                  </div>         
                  </div>
              </div>
            </div>
          </td>
        </tr>
          {% empty %}
          <tr>
            <td colspan="9" class="empty-state">
              <i class="fas fa-inbox"></i>
              <p>No ECG data available</p>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  <div class="pagination-container">
    
      <div class="pagination-left">
        <button id="shareSelectedBtn {% if not user|has_feature:'share' %}disabled-feature{% endif %}" class="btn btn-primary"
         {% if user|has_feature:"share" %}
         {% else %}
          onclick="showUpgradeToast()"
        {% endif %}>

          <i class="fas fa-share-alt"></i>
          <span>Share Selected</span>
        </button>
      </div>
     
<div class="pagination-right" id="paginationControls" data-total-pages="{{ total_pages }}">
    
    <button class="pagination-btn 
        {% if not user|has_feature:'pagination_all' %}disabled-feature{% endif %}"
        
        id="prevBtn"
        {% if not user|has_feature:'pagination_all' %}data-locked="true"{% else %}data-locked="false"{% endif %}
        
        {% if current_page == 1 %}disabled{% endif %}
        title="Previous">
        <i class="fas fa-chevron-left"></i>
    </button>

    <span class="page-info">Page {{ current_page }} of {{ total_pages }}</span>

    <button class="pagination-btn"
        id="nextBtn"
        {% if not user|has_feature:'pagination_all' %}data-locked="true"{% else %}data-locked="false"{% endif %}
        
        {% if current_page == total_pages %}disabled{% endif %}
        title="Next">
        <i class="fas fa-chevron-right"></i>
    </button>

</div>



    </div>
    <div class="scroll-to-top" id="scrollToTop">
      <i class="fas fa-arrow-up"></i>
    </div>
  </div>  
  <div id="share-container"></div>
    <div id="sctreeModal" class="modal fade" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">HRV Scatter Chart</h5>
          </div>
          <div class="modal-body">
            <div id="scttreChart" style="width:100%;height:420px;"></div>
          </div>
        </div>
      </div>
    </div>
{% endblock %}
{% block scripts %}
<script>
    const hasShareFeature = {{ user|has_feature:"share"|yesno:"true,false" }};
</script>

<script src="{% static 'js/scripts.js' %}"></script> 
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.plot.ly/plotly-3.0.0.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

{% endblock %}
