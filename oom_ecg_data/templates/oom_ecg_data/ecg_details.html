{% extends 'ecgdatabank/base.html' %}
{% load static %}
{% block title %}Analysis Tool{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'CSS/ecg_details.css' %}">
{% endblock %}

{% block content %}
<div class="container">
  <input type="hidden" id="csrfToken" value="{{ csrf_token }}">

<div class="header">
  <button class="back-btn" onclick="window.location.href='/ommecgdata/'" aria-label="Go back">
    <i class="fas fa-arrow-left"></i>
  </button>
  <div class="header-text">
    <h2>{{ card_name|default:"Data Management" }}</h2>
    <p>Manage and view your ECG data efficiently with advanced filtering and visualization tools</p>
  </div>
</div>

  <div class="table-container card">
    <div class="table-wrapper">
      <table >
        <thead>
          <tr>
            <th>Sr. No.</th>
            <th>Patient ID</th>
            <th>Lead Type</th>
            <th>Arrhythmia</th>
            <th>Frequency</th>
            <th>duration</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="ecgTableBody">
          {% for data in page_obj %}
          <tr data-object-id="{{ data.object_id }}" data-lead-value="{{ data.LeadNumeric|default:data.Lead }}" class="fade-in">
            <td><strong>{{ forloop.counter }}</strong></td>
            <td>{{ data.PatientID }}</td>
            <td>
              <span>{{ data.Lead }}</span>
            </td>
            <td>{{ data.Arrhythmia }}</td>
            <td>{{ data.Frequency }}</td>
            <td>{{data.duration}}</td>
            <td>
              <div class="action-buttons">
                <button class="icon-btn delete" title="Delete Record">
                  <i class="fas fa-trash delete-btn" data-id="{{ data.object_id }}" data-collection="{{ data.collection_name }}"></i>
                </button>
              </div>
            </td>
          </tr>
          <tr class="plot-row" data-plot-id="{{ data.object_id }}" style="display: none;">
            <td colspan="7">
              <div class="plot-container" id="plot-container-{{ data.object_id }}">
                <div class="modal-header">
                  <h5 class="modal-title">
                    <i class="fas fa-heartbeat" style="color: var(--danger);"></i>
                    ECG Signal - {{ data.PatientID }}

                  </h5>

                  <button type="button" class="btn-close plot-close" data-id="{{ data.object_id }}" aria-label="Close">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
               <div class="plot" id="plot-{{ data.object_id }}"></div> 
              </div>
              <div class="modal-footer">
               <div class="form-group">
                  <label class="form-label" for="Arrhythmia-{{ data.object_id }}">Arrhythmia Type</label>
                  <select class="form-control" id="Arrhythmia-{{ data.object_id }}" name="ArrhythmiaType">
                    <option value="" selected disabled>Select Arrhythmia Type</option>
                    <option value="Premature Ventricular Contraction">Premature Ventricular Contraction</option>
                    <option value="Premature Atrial Contraction">Premature Atrial Contraction</option>
                    <option value="Ventricular Fibrillation and Asystole">Ventricular Fibrillation and Asystole</option>
                    <option value="Junctional Rhythm">Junctional Rhythm</option>
                    <option value="Atrial Fibrillation & Atrial Flutter">Atrial Fibrillation & Atrial Flutter</option>
                    <option value="Myocardial Infarction">Myocardial Infarction</option>
                    <option value="HeartBlock">HeartBlock</option>
                    <option value="Noise">Noise</option>
                    <option value="Others">Others</option>
                    <option value="LBBB">LBBB & RBBB</option>
                  </select>
                </div> 
                
                <div class="form-group">
                  <label class="form-label" for="downloadType-{{ data.object_id }}">Download Type</label>
                  <select class="form-control" id="downloadType-{{ data.object_id }}" name="downloadType">
                    <option value="" selected disabled>Select Download Type</option>
                    <option value="raw_data">Raw Data</option>
                    <option value="plot_pdf">Plot PDF</option>
                    <option value="pqrst_csv">PQRST Detection Points CSV</option>
                    <option value="selected_data">Selected Data</option>
                  </select>
                </div>

                <div class="button-group">

                  <button id="editEcgData-{{ data.object_id }}" data-id="{{ data.object_id }}">
                    <i class="fas fa-edit"></i>
                    Edit
                  </button>
                  <button class="btn btn-success save-btn" id="saveData-{{ data.object_id }}" data-id="{{ data.object_id }}">
                    <i class="fas fa-save"></i>
                    Save 
                  </button>
                  <button class="btn btn-primary confirm-edit-btn" id="confirmEditBtn-{{ data.object_id }}" data-id="{{ data.object_id }}" style="display: none;">
                    <i class="fas fa-check"></i>
                    Confirm
                  </button>
                  <button class="btn btn-secondary" id="closeBtn">
                    <i class="fas fa-times"></i>Close
                  </button>
                </div>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="empty-state">
              <i class="fas fa-inbox"></i>
              <p>No ECG data available</p>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="pagination-container">
      <div class="pagination-controls" id="paginationControls" data-total-pages="{{ total_pages }}">
        <button class="pagination-btn" id="prevBtn" {% if current_page == 1 %}disabled{% endif %} title="Previous">
          <i class="fas fa-chevron-left"></i>
        </button>
        <span class="page-info">Page {{ current_page }} of {{ total_pages }}</span>
        <button class="pagination-btn" id="nextBtn" {% if current_page == total_pages %}disabled{% endif %} title="Next">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>
  
  <div class="scroll-to-top" id="scrollToTop">
    <i class="fas fa-arrow-up"></i>
  </div>
</div>  
<div id="share-container"></div>
{% endblock %}
{% block scripts %}
<script src="{% static 'js/scripts.js' %}"></script> 
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.plot.ly/plotly-3.0.0.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

{% endblock %}
